{% comment %}
  Greywater Directory - Liquid Template for Shopify Theme Integration
  This template will inherit your store's header, footer, and navigation
{% endcomment %}

{% assign page_title = 'Greywater State Laws & Regulations' %}
{% assign page_description = 'Understanding the legal landscape for greywater systems across the United States' %}

<div class="page-width greywater-directory-container">
  <h1 class="section-header__title">{{ 'Greywater State Laws & Regulations' }}</h1>
  <p class="section-header__subtitle">Understanding the legal landscape for greywater systems across the United States</p>

  <div class="greywater-stats-grid">
    <div class="stat-card fully-legal">
      <div class="stat-number" id="fully-legal-count">0</div>
      <div class="stat-label">Fully Legal</div>
      <div class="stat-description">Comprehensive regulations allowing greywater systems with permits</div>
    </div>
    <div class="stat-card restricted">
      <div class="stat-number" id="restricted-count">0</div>
      <div class="stat-label">Restricted</div>
      <div class="stat-description">Limited use, often only specific system types allowed</div>
    </div>
    <div class="stat-card limited">
      <div class="stat-number" id="limited-count">0</div>
      <div class="stat-label">Limited</div>
      <div class="stat-description">Unclear regulations or case-by-case approval</div>
    </div>
    <div class="stat-card prohibited">
      <div class="stat-number" id="prohibited-count">0</div>
      <div class="stat-label">Prohibited</div>
      <div class="stat-description">No greywater systems permitted or no formal regulations</div>
    </div>
  </div>

  <div class="view-toggle">
    <button class="btn toggle-btn active" onclick="showCardView()">Card View</button>
    <button class="btn toggle-btn" onclick="showTableView()">Table View</button>
  </div>

  <div id="card-view" class="states-grid"></div>
  
  <div id="table-view" class="states-table hidden">
    <table>
      <thead>
        <tr>
          <th>State</th>
          <th>Status</th>
          <th>Permit Required</th>
          <th>Indoor Use</th>
          <th>Outdoor Use</th>
          <th>Key Restrictions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <div class="legal-notice">
    <h3>
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
      </svg>
      Important Legal Notice
    </h3>
    <p>This information is for general guidance only and may not reflect the most current regulations. Greywater laws vary significantly by state, county, and municipality. Always consult with local authorities and obtain necessary permits before installing any greywater system.</p>
  </div>
</div>

<style>
  .greywater-directory-container {
    padding: 40px 0;
  }

  .greywater-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 40px 0;
  }

  .stat-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid;
  }

  .stat-card.fully-legal {
    border-left-color: #27ae60;
  }

  .stat-card.restricted {
    border-left-color: #f39c12;
  }

  .stat-card.limited {
    border-left-color: #e67e22;
  }

  .stat-card.prohibited {
    border-left-color: #e74c3c;
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .stat-card.fully-legal .stat-number {
    color: #27ae60;
  }

  .stat-card.restricted .stat-number {
    color: #f39c12;
  }

  .stat-card.limited .stat-number {
    color: #e67e22;
  }

  .stat-card.prohibited .stat-number {
    color: #e74c3c;
  }

  .view-toggle {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 30px 0;
  }

  .toggle-btn {
    padding: 12px 24px;
    border: 2px solid currentColor;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .toggle-btn.active {
    background: var(--color-primary, #333);
    color: white;
  }

  .states-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .state-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .state-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }

  .states-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 40px;
  }

  .states-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .states-table th {
    background: #34495e;
    color: white;
    padding: 20px;
    text-align: left;
    font-weight: 600;
  }

  .states-table td {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
  }

  .states-table tbody tr {
    cursor: pointer;
  }

  .states-table tr:hover {
    background: #f8f9fa;
  }

  .legal-notice {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 12px;
    padding: 25px;
    margin-top: 40px;
  }

  .legal-notice h3 {
    color: #1976d2;
    margin-bottom: 15px;
  }

  .hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .greywater-stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .states-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // State data would be loaded from your API
  let stateData = [];

  // Load state data from API
  async function loadStateData() {
    try {
      const response = await fetch('{{ shop.url }}/apps/greywater-directory?action=data');
      const data = await response.json();
      stateData = data.states;
      updateStats();
      renderCardView();
      renderTableView();
    } catch (error) {
      console.error('Error loading state data:', error);
    }
  }

  function updateStats() {
    const counts = {
      'Fully Legal': 0,
      'Restricted': 0,
      'Limited': 0,
      'Prohibited': 0
    };

    stateData.forEach(state => {
      counts[state.status]++;
    });

    document.getElementById('fully-legal-count').textContent = counts['Fully Legal'];
    document.getElementById('restricted-count').textContent = counts['Restricted'];
    document.getElementById('limited-count').textContent = counts['Limited'];
    document.getElementById('prohibited-count').textContent = counts['Prohibited'];
  }

  function getStatusClass(status) {
    return status.toLowerCase().replace(/\s+/g, '-');
  }

  function renderCardView() {
    const cardView = document.getElementById('card-view');
    cardView.innerHTML = stateData.map(state => `
      <div class="state-card" onclick="showStateDetails('${state.state}')">
        <div class="state-header">
          <div class="state-name">${state.state}</div>
          <div class="status-badge status-${getStatusClass(state.status)}">${state.status}</div>
        </div>
        <div class="state-description">${state.description}</div>
        <div class="state-details">${state.details}</div>
      </div>
    `).join('');
  }

  function renderTableView() {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = stateData.map(state => `
      <tr onclick="showStateDetails('${state.state}')">
        <td><strong>${state.state}</strong></td>
        <td><span class="status-badge status-${getStatusClass(state.status)}">${state.status}</span></td>
        <td>${state.permitRequired}</td>
        <td>${state.indoorUseAllowed ? '✓' : '✗'}</td>
        <td>${state.outdoorUseAllowed ? '✓' : '✗'}</td>
        <td>${state.keyRestrictions ? state.keyRestrictions.slice(0, 2).join('. ') : ''}</td>
      </tr>
    `).join('');
  }

  function showCardView() {
    document.getElementById('card-view').classList.remove('hidden');
    document.getElementById('table-view').classList.add('hidden');
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
  }

  function showTableView() {
    document.getElementById('card-view').classList.add('hidden');
    document.getElementById('table-view').classList.remove('hidden');
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
  }

  function showStateDetails(stateName) {
    // Navigate to state detail page
    window.location.href = `{{ shop.url }}/apps/greywater-directory?action=state-page&state=${encodeURIComponent(stateName)}`;
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', loadStateData);
</script>